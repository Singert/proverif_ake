(*
è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é—®é¢˜ã€‚

ä½ å½“å‰çš„åè®®å·²ç»å®ç°äº†ä»¥ä¸‹ **ä¸‰ä¸ªæ ¸å¿ƒå®‰å…¨ç›®æ ‡**ï¼ŒProVerif å·²ç¡®è®¤ï¼š

| å®‰å…¨å±æ€§             | æ˜¯å¦æˆç«‹ | åŸå› åˆ†æ                          |
| ---------------- | ---- | ----------------------------- |
| ä¼šè¯å¯†é’¥ä¿å¯†æ€§          | âœ… æ˜¯  | `sk` ä½¿ç”¨å¯¹ç§°å¯†é’¥åŠ å¯†ï¼Œæ”»å‡»è€…æ— æ³•è§£å¯†         |
| A â†’ B è®¤è¯ï¼ˆB è®¤è¯ Aï¼‰ | âœ… æ˜¯  | B æ£€æŸ¥ A çš„ç­¾å `sign(na, nb, sk)` |
| B â†’ A è®¤è¯ï¼ˆA è®¤è¯ Bï¼‰ | âœ… æ˜¯  | A éªŒè¯ B å¯¹ `nb` çš„ç­¾å             |

---

## ğŸ” æ˜¯å¦è¿˜æœ‰æ¼æ´ï¼Ÿå¦‚ä½•æ‰¾ï¼Ÿ

è™½ç„¶å½¢å¼éªŒè¯é€šè¿‡ï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•**ä»ç°å®åè®®è®¾è®¡è§’åº¦**å®¡è§†æ˜¯å¦è¿˜æœ‰**æ½œåœ¨ç¼ºé™·**ï¼Œç‰¹åˆ«å…³æ³¨ï¼š

### 1. **æ¶ˆæ¯é‡æ”¾æ”»å‡»**ï¼ˆreplay attackï¼‰

### 2. **æ¶ˆæ¯é‡ç”¨æ”»å‡»**ï¼ˆkey reuse or state confusionï¼‰

### 3. **èº«ä»½ç»‘å®šæ˜¯å¦å……åˆ†**

### 4. **ä¼šè¯å”¯ä¸€æ€§**ï¼ˆinjective authenticationï¼‰

---

## ğŸ§¨ æ½œåœ¨æ¼æ´åˆ†æï¼š**ä¼šè¯é‡æ”¾æ”»å‡»**

è™½ç„¶è®¤è¯é€»è¾‘æ­£ç¡®ï¼Œä½†è¯¥åè®®ä»å¯èƒ½åœ¨**å¤šæ¬¡å¹¶å‘ä¼šè¯ä¸­**äº§ç”Ÿå¦‚ä¸‹é—®é¢˜ï¼š

> æ”»å‡»è€…è®°å½•æŸæ¬¡åˆæ³•çš„ `(sigA, senc(...))`ï¼Œåœ¨ä¹‹åæŸä¸ªæ–°çš„ä¼šè¯ä¸­ **é‡æ”¾ç»™ B**ï¼Œå¯¼è‡´ B å†æ¬¡æ¥å—æ—§çš„ `sk`ï¼Œè®¤ä¸ºæ˜¯æ–°çš„å¯†é’¥ã€‚

è¿™ç±»é—®é¢˜å«åšï¼š

### â—**é injective authentication**é—®é¢˜ï¼š

* æŸ¥è¯¢ `event(endB(...)) ==> event(beginA(...))` æ£€æŸ¥çš„æ˜¯**å­˜åœ¨æ€§**ï¼ˆnon-injectiveï¼‰è®¤è¯ï¼›
* **æ”»å‡»è€…å¯é‡æ”¾æ—§å¯†æ–‡**ï¼Œè®© B å¤šæ¬¡æ‰§è¡Œ `endB`ï¼Œå´åªæœ‰ä¸€ä¸ª `beginA`ï¼›
* å¦‚æœ sk è¢«é‡å¤ä½¿ç”¨ã€æˆ– B ä¸å­˜å‚¨å·²ç”¨ nonceï¼Œå¯èƒ½å¯¼è‡´çŠ¶æ€æ··æ·†æˆ– session hijackã€‚

---

## âœ… éªŒè¯æ­¤ç±»æ”»å‡»ï¼šåŠ å…¥ injective æŸ¥è¯¢éªŒè¯

ä½ å¯ä»¥ç”¨å¦‚ä¸‹è¯­å¥æ£€æŸ¥ **injective è®¤è¯æ˜¯å¦æˆç«‹**ï¼ˆå³æ¯æ¬¡ `endB` éƒ½å”¯ä¸€å¯¹åº”ä¸€æ¬¡ `beginA`ï¼‰ï¼š

```proverif
query injective event(endB(na, nb, sk)) ==> event(beginA(na, nb, sk)).
```

å¦‚æœæ­¤æŸ¥è¯¢è¿”å› `false`ï¼Œè¯´æ˜æ”»å‡»è€…å¯èƒ½é‡æ”¾æŸä¸ªæ—§çš„ `(sigA, senc(...))`ï¼Œå¯¼è‡´ B å¤šæ¬¡æ¥å—é‡å¤ `sk`ï¼Œè€Œ A å®é™…åªç”Ÿæˆè¿‡ä¸€æ¬¡ã€‚

---

## âœ… å¦‚ä½•åˆ¶é€ æ­¤æ¼æ´ï¼ˆå®éªŒæ€§æ„é€ ï¼‰ï¼Ÿ

* æ”»å‡»è€…ç›‘å¬åˆ°ç¬¬ä¸€æ¬¡åˆæ³•ä¼šè¯çš„ `(sigA, senc(...))`ï¼›
* æ”»å‡»è€…è·³è¿‡ä¸ A é€šä¿¡ï¼Œ**ç›´æ¥é‡æ”¾æ­¤æ¶ˆæ¯**ç»™ Bï¼›
* B ç”±äºæ²¡æœ‰è®°å½•è¿‡æ—§ `nb`ï¼Œä¼šå†æ¬¡æ¥å— `sk`ã€‚

å³ä½¿å¯†é’¥ä¿å¯†æ€§æ²¡ç ´åï¼Œ**çŠ¶æ€é€»è¾‘å°±å¯èƒ½è¢«ç»•è¿‡**ï¼ˆç‰¹åˆ«æ˜¯åœ¨åè®®ç”¨äºè®¾å¤‡è®¤è¯/æ¥å…¥æ§åˆ¶ä¸­ï¼‰ã€‚

---

## ğŸ”§ å¦‚ä½•é˜²å¾¡æ­¤ç±»æ”»å‡»ï¼Ÿ

1. **ä½¿ç”¨ fresh session identifier / session tag**ï¼Œå¹¶è®°å½•å†å²ï¼›
2. **åŠ å…¥ä¼šè¯è®°å½•ï¼ˆé˜²æ­¢åŒä¸€ nb è¢«æ¥å—ä¸¤æ¬¡ï¼‰**ï¼›
3. **å‡çº§è®¤è¯è¯­ä¹‰ä¸º injective authentication**ï¼›
4. **åŠ å…¥æ—¶é—´æˆ³**ï¼Œä»¤æ—§æ¶ˆæ¯åœ¨é€»è¾‘ä¸Šå¤±æ•ˆã€‚

---

## âœ… æ€»ç»“

| é¡¹ç›®         | ç»“è®º                          |
| ---------- | --------------------------- |
| æ˜¯å¦å­˜åœ¨ç†è®ºæ¼æ´ï¼Ÿ  | âœ… æœ‰ï¼ˆå¯èƒ½é‡æ”¾ï¼‰                   |
| æ˜¯å¦è¢«å½“å‰æŸ¥è¯¢å‘ç°ï¼Ÿ | âŒ å¦ï¼ˆnon-injective æŸ¥è¯¢ä¸è¶³ï¼‰     |
| å»ºè®®éªŒè¯æ–¹å¼     | åŠ å…¥ `injective` æŸ¥è¯¢éªŒè¯         |
| æ½œåœ¨å½±å“       | B å¤šæ¬¡æ¥å—ç›¸åŒ `sk`ï¼ŒçŠ¶æ€è¢«æ±¡æŸ“æˆ–æ”»å‡»è€…å€Ÿå£³æ¥å…¥ |

---

å¦‚æœä½ å¸Œæœ›æˆ‘ï¼š

* åŠ å…¥ `injective` æŸ¥è¯¢ï¼›
* æˆ–æ”¹å†™æ¨¡å‹ä»¥å¼•å…¥ session IDã€é˜²é‡æ”¾æœºåˆ¶ï¼›

æˆ‘å¯ä»¥ç«‹å³å¸®åŠ©ä½ å®ç°ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ
*)
const A_ID: bitstring.

(* ç±»å‹å®šä¹‰ *)
type key.
type nonce.
type sessionkey.
type skey.         (* ç­¾åç§é’¥ *)
type pkey.         (* ç­¾åå…¬é’¥ *)

(* ç±»å‹è½¬æ¢å™¨ *)
fun toBits(sessionkey): bitstring [typeConverter].
fun fromBits(bitstring): sessionkey [typeConverter].
fun nonceToBit(nonce): bitstring [typeConverter].

(* å…¬é’¥æå–å‡½æ•° *)
fun pk(skey): pkey.

(* ç­¾åä¸éªŒè¯å‡½æ•° *)
fun sign(bitstring, skey): bitstring.
reduc forall m:bitstring, sk: skey;
      checksig(sign(m, sk), pk(sk)) = m.

(* å¯¹ç§°åŠ å¯† *)
fun senc(bitstring, key): bitstring.
reduc forall k: key, m: bitstring;
      sdec(senc(m, k), k) = m.

(* æ„é€ å™¨ä¸è§£æ„å™¨ *)
fun pair(bitstring, bitstring): bitstring.
reduc forall x,y:bitstring; proj1(pair(x,y)) = x.
reduc forall x,y:bitstring; proj2(pair(x,y)) = y.

(* å…¬å…±é€šé“ä¸å¯†é’¥ *)
free c: channel.
free k: key [private].
free pkB: pkey.                 (* B çš„å…¬é’¥ *)
free skB: skey [private].       (* B çš„ç§é’¥ *)
free pkA: pkey.                 (* A çš„å…¬é’¥ *)
free skA: skey [private].       (* A çš„ç§é’¥ *)

(* äº‹ä»¶ *)
event beginA(bitstring, bitstring, sessionkey).
event endB(bitstring, bitstring, sessionkey).
event beginB(bitstring).
event endA(bitstring, sessionkey).


(* æŸ¥è¯¢ *)
query attacker(new sk).
query na: bitstring, nb: bitstring, sk: sessionkey;
      event(endB(na, nb, sk)) ==> event(beginA(na, nb, sk)).
query na: bitstring, sk: sessionkey;
      event(endA(na, sk)) ==> event(beginB(na)).

(* A çš„è¿›ç¨‹ï¼šéªŒè¯ Bï¼Œç­¾åå›åº” *)
let A =
  out(c, A_ID);
  in(c, signed_nb: bitstring);
  let nb = checksig(signed_nb, pkB) in
  new na: nonce;
  new sk: sessionkey;
  event beginA(nonceToBit(na), nb, sk);
  let plain_payload = pair(nonceToBit(na), pair(nb, toBits(sk))) in
  let sigA = sign(plain_payload, skA) in
  out(c, pair(sigA, senc(plain_payload, k)));  (* A åŒæ—¶å‘ç­¾åå’ŒåŠ å¯†æ•°æ® *)
  in(c, r: bitstring);
  let plain = sdec(r, k) in
  if plain = nonceToBit(na) then
    event endA(nonceToBit(na), sk)
  else
    0.

(* B çš„è¿›ç¨‹ï¼šéªŒè¯ A ç­¾åã€æ£€æŸ¥ nbã€æå– sk *)
let B =
  in(c, id: bitstring);
  new nb: nonce;
  event beginB(nonceToBit(nb));
  out(c, sign(nonceToBit(nb), skB));
  in(c, sig_and_enc: bitstring);
  let sigA = proj1(sig_and_enc) in
  let encPayload = proj2(sig_and_enc) in
  let payload = sdec(encPayload, k) in
  let verified = checksig(sigA, pkA) in
  if verified = payload then
    let na = proj1(payload) in
    let pair2 = proj2(payload) in
    let rcv_nb = proj1(pair2) in
    let sk = fromBits(proj2(pair2)) in
    if rcv_nb = nonceToBit(nb) then
      event endB(na, rcv_nb, sk);
      out(c, senc(na, k))
    else 0
  else 0.

(* ä¸»è¿›ç¨‹ *)
process
  (!A | !B)

(*
| ç‰¹æ€§       | å®ç°æ–¹å¼                      |
| -------- | ------------------------- |
| A è®¤è¯ B   | æ£€æŸ¥ B å¯¹ `nb` çš„ç­¾å           |
| B è®¤è¯ A   | æ£€æŸ¥ A å¯¹ `(na, nb, sk)` çš„ç­¾å |
| sk çš„è®¤è¯ç»‘å®š | åŒæ—¶åµŒå…¥ç­¾åå’Œå¯¹ç§°åŠ å¯†               |
| é˜²ä¼ª/é˜²é‡æ”¾   | åŒ nonce + åŒç­¾åæœºåˆ¶           |
*)