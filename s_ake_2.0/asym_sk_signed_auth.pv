(*| å®‰å…¨ç›®æ ‡             | æ˜¯å¦è¾¾æˆ  | æœºåˆ¶è¯´æ˜                   |
| ---------------- | ----- | ---------------------- |
| æ‘†è„±å…±äº«å¯†é’¥           | âœ… æ˜¯   | sk ç”¨ B çš„å…¬é’¥åŠ å¯†           |
| åŒå‘è®¤è¯             | âœ… æ˜¯   | åŒæ–¹ç­¾åå½¼æ­¤æ¶ˆæ¯               |
| sk ä¿å¯†æ€§           | âœ… æ˜¯   | æ”»å‡»è€…æ— æ³•è§£å¯† `asymenc(...)` |
| æŠ—é‡æ”¾æ”»å‡»ï¼ˆinjectiveï¼‰ | âœ… å¯éªŒè¯ | `inj-event` æˆç«‹         |
| åŸºäºå…¬é’¥æ¶æ„ï¼ˆPKIï¼‰      | âœ… æ˜¯   | ä¿¡ä»» `pkA` ä¸ `pkB`       |
*)
(*
| ä¼˜ç‚¹    | æè¿°                                              |
| ----- | ----------------------------------------------- |
| ç»“æ„æ¸…æ™°  | æ¯ä¸ªè§’è‰²çš„é€»è¾‘å•ç‹¬å®šä¹‰ï¼Œä¾¿äºé˜…è¯»ä¸ç®¡ç†                             |
| æ˜“æ‰©å±•   | åç»­å¯ä»¥å¢åŠ  `B_init`, `A_resp`, `SessionManager` ç­‰æ¨¡å— |
| æ”¯æŒå¤šå®ä¾‹ | `!A_init` è¡¨ç¤º A å¯å¤šæ¬¡å‘èµ·ï¼Œæ¨¡æ‹Ÿå¹¶å‘æˆ–å¤šäººé€šä¿¡                  |
| å¯è°ƒæµ‹è¯•  | åªæ›¿æ¢æˆ–æ³¨é‡Šéƒ¨åˆ†æ¨¡å—å³å¯æµ‹è¯•ä¸åŒåœºæ™¯                              |
*)
const A_ID: bitstring.

(* ç±»å‹å®šä¹‰ *)
type nonce.
type sessionkey.
type skey.
type pkey.
type skey_enc.
type pkey_enc.

(* ç±»å‹è½¬æ¢å™¨ *)
fun toBits(sessionkey): bitstring [typeConverter].
fun fromBits(bitstring): sessionkey [typeConverter].

(* å…¬é’¥æ˜ å°„ *)
fun pk(skey): pkey.
fun pk_enc(skey_enc): pkey_enc.

(* ç­¾åå‡½æ•° *)
fun sign(bitstring, skey): bitstring.
reduc forall m: bitstring, sk: skey;
      checksig(sign(m, sk), pk(sk)) = m.

(* éå¯¹ç§°åŠ è§£å¯† *)
fun asymenc(bitstring, pkey_enc): bitstring.
reduc forall m: bitstring, k: skey_enc;
      asymdec(asymenc(m, pk_enc(k)), k) = m.

(* æ•°æ®ç»“æ„ *)
fun pair(bitstring, bitstring): bitstring.
reduc forall x, y: bitstring; proj1(pair(x, y)) = x.
reduc forall x, y: bitstring; proj2(pair(x, y)) = y.

(* é€šé“ä¸å¯†é’¥ *)
free c: channel.

free pkB: pkey.
free skB: skey [private].
free pkB_enc: pkey_enc.
free skB_enc: skey_enc [private].

free pkA: pkey.
free skA: skey [private].

(* äº‹ä»¶å®šä¹‰ *)
event beginA(bitstring, bitstring, sessionkey).
event endB(bitstring, bitstring, sessionkey).
event beginB(bitstring).
event endA(bitstring, sessionkey).

(* æŸ¥è¯¢å®šä¹‰ *)
query attacker(new sk).
query na: bitstring, nb: bitstring, sk: sessionkey;
      event(endB(na, nb, sk)) ==> event(beginA(na, nb, sk)).
query na: bitstring, sk: sessionkey;
      event(endA(na, sk)) ==> event(beginB(na)).
query na: bitstring, nb: bitstring, sk: sessionkey;
      inj-event(endB(na, nb, sk)) ==> inj-event(beginA(na, nb, sk)).

(* æ¨¡å— A_initï¼šA å‘èµ·æ–¹ *)
let A_init =
  out(c, A_ID);
  in(c, signed_nb: bitstring);
  let nb = checksig(signed_nb, pkB) in
  new na: bitstring;
  new sk: sessionkey;
  event beginA(na, nb, sk);
  let payload = pair(na, pair(nb, toBits(sk))) in
  let sigA = sign(payload, skA) in
  out(c, pair(sigA, asymenc(payload, pkB_enc)));
  in(c, r: bitstring);
  if r = na then
    event endA(na, sk)
  else
    0.

(* æ¨¡å— B_respï¼šB å“åº”æ–¹ *)
let B_resp =
  in(c, id: bitstring);
  new nb: bitstring;
  event beginB(nb);
  out(c, sign(nb, skB));
  in(c, sig_and_enc: bitstring);
  let sigA = proj1(sig_and_enc) in
  let encPayload = proj2(sig_and_enc) in
  let payload = asymdec(encPayload, skB_enc) in
  let verified = checksig(sigA, pkA) in
  if verified = payload then
    let na = proj1(payload) in
    let pair2 = proj2(payload) in
    let rcv_nb = proj1(pair2) in
    let sk = fromBits(proj2(pair2)) in
    if rcv_nb = nb then
      event endB(na, rcv_nb, sk);
      out(c, na)
    else 0
  else 0.

(* ä¸»è¿›ç¨‹ï¼šæ¨¡å—ç»„åˆ *)
process
  (!A_init | !B_resp)


(*TODO:åç»­æ‰©å±•æ–¹å‘
| æ–¹å‘                         | è¯´æ˜                                              |
| -------------------------- | ----------------------------------------------- |
| ğŸ”„ æ·»åŠ å‰å‘å®‰å…¨æ€§ï¼ˆPFSï¼‰            | å¼•å…¥ ephemeral DHï¼š`g^a`, `g^b`ï¼Œç”¨ `g^{ab}` æ´¾ç”Ÿ `sk` |
| â³ åŠ å…¥ sessionID / timestamp | é™åˆ¶æ¯è½®è®¤è¯çš„ä¸Šä¸‹æ–‡ï¼Œå¢å¼º replay æŠµæŠ—æ€§                        |
| ğŸ” æ¨¡æ‹Ÿæ”»å‡»è€…ç­–ç•¥ä¸‹ trace è¾“å‡º       | ä½¿ç”¨ `set traceDisplay = long.` åˆ†ææ”»å‡»åœºæ™¯            |
| ğŸ” å®ç° TLS 1.3 ç±» handshake  | é€šè¿‡æ„é€  KeyShare/Finished æ¨¡æ‹Ÿæ ‡å‡†åè®®                   |
| ğŸ“š å½¢å¼åŒ–ä¸º AKE å®‰å…¨æ¨¡å‹ç»“æ„         | å¦‚ SIG-DHã€eCKï¼Œé€‚ç”¨äºæŠ¥å‘Šæˆ–å‘è¡¨                           |



TODO:ğŸ“¦ å°è£…ä¸ºå¤šä¸ª process å’Œæ¨¡å—ï¼ˆA_initã€B_respï¼‰ï¼›

TODO:ğŸ§ª ç»§ç»­éªŒè¯å…¶ä»–å±æ€§ï¼ˆKCIã€PFSã€key confirmationï¼‰ï¼›

TODO:ğŸ“„ æˆ‘å¸®ä½ æ•´ç†æˆæ­£å¼æŠ¥å‘Šç»“æ„æˆ–æ³¨é‡Šç‰ˆå¯è¯»ä»£ç ï¼›
*)