(*å¯ç”¨æ”»å‡»è·¯å¾„è¾“å‡º*)
set traceDisplay = long.

(* === A çš„èº«ä»½å¸¸é‡ === *)
const A_ID: bitstring.

(* === ç±»å‹å®šä¹‰ === *)
type exp.                  (* DH æŒ‡æ•°ç±»å‹ï¼ˆç§é’¥ï¼‰ *)
type group.                (* ç¾¤å…ƒç´ ç±»å‹ï¼ˆå¦‚ g^xï¼‰ *)
type sessionkey.           (* ä¼šè¯å¯†é’¥ç±»å‹ *)
type skey.                 (* ç­¾åç§é’¥ç±»å‹ *)
type pkey.                 (* ç­¾åå…¬é’¥ç±»å‹ *)
type skey_enc.             (* éå¯¹ç§°åŠ å¯†ç§é’¥ç±»å‹ *)
type pkey_enc.             (* éå¯¹ç§°åŠ å¯†å…¬é’¥ç±»å‹ *)

(* === ç¾¤ç”Ÿæˆå…ƒ === *)
free g: group.  (* å…¬å…±ç”Ÿæˆå…ƒ *)

(* === ç¼–ç å‡½æ•° === *)
fun encode_group(group): bitstring.

(* === å…¬é’¥å‡½æ•° === *)
fun pk(skey): pkey.
fun pk_enc(skey_enc): pkey_enc.

(* === ç­¾åå‡½æ•°ä¸éªŒè¯ === *)
fun sign(bitstring, skey): bitstring.
fun checksig(bitstring, pkey): bitstring.
equation forall m: bitstring, sk: skey;
  checksig(sign(m, sk), pk(sk)) = m.

(* === åŠ è§£å¯†å‡½æ•° === *)
fun asymenc(bitstring, pkey_enc): bitstring.
fun asymdec(bitstring, skey_enc): bitstring.
equation forall m: bitstring, k: skey_enc;
  asymdec(asymenc(m, pk_enc(k)), k) = m.

(* === Diffie-Hellman ç›¸å…³å‡½æ•° === *)
fun g_exp(group, exp): group.
fun mult(group, group): group.
fun h(group): sessionkey.
fun exp_add(exp, exp): exp.
equation forall G: group, x: exp, y: exp;
  mult(g_exp(G, x), g_exp(G, y)) = g_exp(G, exp_add(x, y)).

(* === æ„é€ å™¨ä¸è§£æ„å™¨ === *)
fun pair(bitstring, bitstring): bitstring.
fun proj1(bitstring): bitstring.
fun proj2(bitstring): bitstring.
equation forall x: bitstring, y: bitstring;
  proj1(pair(x, y)) = x.
equation forall x: bitstring, y: bitstring;
  proj2(pair(x, y)) = y.

(* === é€šä¿¡ä¿¡é“ === *)
free c: channel.

(* === A/B çš„å¯†é’¥å®šä¹‰ === *)
free pkA: pkey.
free skA: skey [private].
free pkB: pkey.
free skB: skey [private].
free pkB_enc: pkey_enc.
free skB_enc: skey_enc [private].

(* === äº‹ä»¶å®šä¹‰ === *)
event beginA(bitstring, bitstring, sessionkey).      (* A å‘èµ·åè®®ï¼šè‡ªå·±çš„èº«ä»½ã€å¯¹æ–¹èº«ä»½ã€å…¬é’¥æ´¾ç”Ÿå¯†é’¥ *)
event endA(bitstring, sessionkey).                   (* A ç»“æŸï¼šè®°å½•å¯¹æ–¹èº«ä»½ä¸å¯†é’¥ *)

event beginB(bitstring).                             (* B å¼€å§‹æ¥æ”¶ A çš„å…¬é’¥ *)
event endB(bitstring, bitstring, sessionkey).        (* B ç»“æŸï¼šè®°å½• A èº«ä»½ã€B èº«ä»½ã€å¯†é’¥ *)

(* === æŸ¥è¯¢å®šä¹‰ === *)

(* 1. ä¿å¯†æ€§ï¼šæ”»å‡»è€…æ˜¯å¦èƒ½å¾—åˆ°ä¼šè¯å¯†é’¥ *)
query x: sessionkey; attacker(x).

(* 2. B <- A çš„è®¤è¯æ€§ï¼šè‹¥ B è®¤ä¸ºåå•†å®Œæˆï¼ˆendBï¼‰ï¼Œåˆ™ä¸€å®šæœ‰ A å‘èµ·äº† beginA *)
query idA: bitstring, idB: bitstring, sk: sessionkey;
  event(endB(idA, idB, sk)) ==> event(beginA(idA, idB, sk)).

(* 3. ä¼šè¯å¯†é’¥ä¸€è‡´æ€§ï¼šè‹¥ A å®Œæˆå¯†é’¥åå•†ï¼Œåˆ™ B ä¹Ÿåå•†å‡ºäº†ç›¸åŒå¯†é’¥ *)
query a_id: bitstring, b_id: bitstring, sk: sessionkey;
  event(endA(b_id, sk)) ==> event(endB(a_id, b_id, sk)).


(* === æ–°å¢ B ç­¾åæœºåˆ¶ï¼ˆä¿®å¤ç‰ˆï¼‰ === *)

(* A çš„è¿‡ç¨‹ *)
let A =
  new a: exp;
  let A_pub = g_exp(g, a) in
  let sigA = sign(encode_group(A_pub), skA) in

  out(c, A_ID);
  out(c, sigA);
  out(c, A_pub);

  in(c, B_pub: group);
  in(c, sigB: bitstring);

  let verifiedB = checksig(sigB, pkB) in
  if verifiedB = encode_group(B_pub) then
    let shared = h(mult(B_pub, A_pub)) in
    event beginA(A_ID, encode_group(B_pub), shared);
    event endA(encode_group(B_pub), shared)
  else 0.

(* B çš„è¿‡ç¨‹ *)
let B =
  new b: exp;
  let B_pub = g_exp(g, b) in
  let sigB = sign(encode_group(B_pub), skB) in

  in(c, id: bitstring);
  in(c, sigA: bitstring);
  in(c, A_pub: group);

  let verified = checksig(sigA, pkA) in
  if verified = encode_group(A_pub) then
    let shared = h(mult(A_pub, B_pub)) in
    event beginB(encode_group(A_pub));
    out(c, B_pub);
    out(c, sigB);
    event endB(id, encode_group(B_pub), shared)
  else 0.


(* === ä¸»è¿›ç¨‹ === *)
process
  (!A) | (!B)

(*
ä½ è¿™æ¬¡è¿è¡Œçš„æ˜¯å¸¦æœ‰ç­¾åè®¤è¯çš„ ä¿®å¤ç‰ˆæœ¬ SIG_DH/dh_with_sig.pvï¼Œä»è¾“å‡ºç»“æœæ¥çœ‹ï¼š

âœ… éªŒè¯ç»“æœæ€»ç»“
æŸ¥è¯¢å†…å®¹	ç»“æœ	å«ä¹‰
query not attacker(x)	âŒ false	æ”»å‡»è€…å¯èƒ½çŸ¥æ™“æŸä¸ªå¯†é’¥ï¼ˆè¯¦è§ä¸‹ï¼‰
endB(idA,idB,sk) ==> beginA(idA,idB,sk)	âœ… true	B çš„è®¤è¯æˆåŠŸï¼ˆB åªæ¥å— A å‘èµ·çš„ä¼šè¯ï¼‰
endA(b_id,sk) ==> endB(a_id,b_id,sk)	âœ… true	A ä¸ B çš„å¯†é’¥ä¸€è‡´æ€§å¾—åˆ°ä¿è¯

ğŸ§  è§£è¯»é‡ç‚¹ï¼šè®¤è¯æˆåŠŸï¼Œä½†ä¿å¯†æ€§å¤±è´¥
è¿™æ˜¯æœ€å…³é”®çš„å‘ç° â€”â€” ä½ ä¿®å¤äº†è®¤è¯æ€§é—®é¢˜ï¼Œä½† not attacker(x) ä»ä¸º falseï¼Œè¯´æ˜æ”»å‡»è€…ä»ç„¶èƒ½å¾—åˆ°æŸä¸ªå¯†é’¥ï¼

ğŸ” åˆ†æå¯èƒ½åŸå› ï¼š
ä½ çš„ sessionkey æ˜¯è¿™æ ·ç”Ÿæˆçš„ï¼š

proverif
å¤åˆ¶
ç¼–è¾‘
let shared = h(mult(B_pub, A_pub))
è€Œ attacker å¯çŸ¥ï¼š

A çš„ g^aï¼ˆå³ A_pubï¼‰æ˜¯å¹¿æ’­å‡ºå»çš„ï¼›

B çš„ g^bï¼ˆå³ B_pubï¼‰è™½ç„¶å¸¦ç­¾åï¼Œä½†æ”»å‡»è€…èƒ½çœ‹åˆ° å…¶å€¼ï¼ˆè™½ç„¶æ— æ³•ä¼ªé€ ï¼‰ï¼›

mult(...) æ˜¯å…¬å¼€å‡½æ•°ï¼›

h(...) ä¹Ÿæ˜¯å…¬å¼€å‡½æ•°ã€‚

æ‰€ä»¥ è™½ç„¶æ”»å‡»è€…ä¸èƒ½ä¼ªé€ ç­¾åï¼Œä¹Ÿä¸èƒ½â€œå‡å†’ Bâ€ï¼Œä½†ä»–ä»¬èƒ½çœ‹åˆ° g^a, g^bï¼Œäºæ˜¯èƒ½ç®—å‡º h(g^{ab})ï¼Œè¿™å¯¼è‡´ ä¿å¯†æ€§ä»ç„¶å¤±è´¥ã€‚

âœ… è§£å†³æ–¹å¼ï¼šåŠ å…¥ DH ç§é’¥ä¿æŠ¤ï¼ˆä¾‹å¦‚ ECIES é£æ ¼ï¼‰
âœ… æ–¹æ³•ä¸€ï¼šå°† shared ç”¨ hash(secret) è€Œä¸æ˜¯ hash(public) è¡¨ç¤º
ä¾‹å¦‚ï¼š

proverif
å¤åˆ¶
ç¼–è¾‘
let shared = h(secret_dh_value)
ä½†åœ¨ ProVerif ä¸­ï¼Œg^ab æ˜¯å¯ä»¥è¢«è¿˜åŸçš„ï¼Œæ‰€ä»¥æœ€å¥½ç”¨ï¼š

âœ… æ–¹æ³•äºŒï¼šåœ¨ shared ç”Ÿæˆåç«‹åˆ»åŠ å¯†ä½¿ç”¨ï¼ˆç°å®ä¸­å¸¸åšï¼‰
ä¹Ÿå¯ä»¥ç”¨ h(a || b || g^{ab}) åŠ å¤§æ”»å‡»è€…è¿˜åŸéš¾åº¦ã€‚

âœ… è¯¾å ‚å±•ç¤ºå»ºè®®
ä½ ç°åœ¨æ‹¥æœ‰çš„å®Œæ•´é—­ç¯éå¸¸æœ‰ä»·å€¼ï¼Œå¯ä»¥å¦‚ä¸‹å®‰æ’ä½ çš„å±•ç¤ºç»“æ„ï¼š

ç¯èŠ‚	å†…å®¹	æ¼”ç¤ºæ–¹å¼
âœ… åè®®å»ºæ¨¡	A, B ç­¾åæœºåˆ¶å»ºæ¨¡å®Œæ•´	å±•ç¤º ProVerif ä»£ç 
âŒ åŸå§‹ç‰ˆæœ¬å¤±è´¥	ä¸­é—´äººæ’å…¥ B_pub â†’ éªŒè¯å¤±è´¥	æ¼”ç¤ºæ”»å‡»è½¨è¿¹æˆªå›¾
âœ… ä¿®å¤ç‰ˆæœ¬æˆåŠŸè®¤è¯	åŠ å…¥ sigB åè®¤è¯æˆåŠŸ	å±•ç¤º ProVerif è¾“å‡º
âš ï¸ ä»æœ‰ä¿å¯†æ€§é—®é¢˜	attacker ä»èƒ½è¿˜åŸ g^{ab}	å¼ºè°ƒâ€œå½¢å¼ä¸Šè®¤è¯ vs å®é™…ä¸Šä¿å¯†â€å¯¹æ¯”
âœ… æå‡ºæ”¹è¿›æ–¹å‘	å»ºè®®ä½¿ç”¨ PFSã€KDFã€åŠ å¯†å…±äº«å¯†é’¥	æå‡º ECIES å¼è®¾è®¡å¯å‘

âœ… æ˜¯å¦éœ€è¦æˆ‘ç»§ç»­å¸®åŠ©ä½ ï¼Ÿ
ä½ å¯ä»¥ç»§ç»­æå‡ºï¼š

å¸®æˆ‘ç”»â€œä¿®å¤å‰ vs ä¿®å¤åâ€çš„å¯¹æ¯”å›¾

è¯·å†™å‡ºè¯¥é—­ç¯çš„ PPT æ¼”ç¤ºç»“æ„æˆ–å¹»ç¯ç‰‡è‰ç¨¿

è¯·ç»™æˆ‘ä¸€ä¸ªçœŸå®å¯ä¿å¯†çš„æ”¹è¿›å»ºæ¨¡ç‰ˆæœ¬ï¼ˆå¦‚æ”¹ä¸º encrypt(g^ab)ï¼‰

æˆ‘å¯ä»¥ç«‹å³ä¸ºä½ ç”Ÿæˆè¿™äº›ææ–™ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ


*)