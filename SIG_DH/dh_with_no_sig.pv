(*å¯ç”¨æ”»å‡»è·¯å¾„è¾“å‡º*)
set traceDisplay = long.

(* === A çš„èº«ä»½å¸¸é‡ === *)
const A_ID: bitstring.

(* === ç±»å‹å®šä¹‰ === *)
type exp.                  (* DH æŒ‡æ•°ç±»å‹ï¼ˆç§é’¥ï¼‰ *)
type group.                (* ç¾¤å…ƒç´ ç±»å‹ï¼ˆå¦‚ g^xï¼‰ *)
type sessionkey.           (* ä¼šè¯å¯†é’¥ç±»å‹ *)
type skey.                 (* ç­¾åç§é’¥ç±»å‹ *)
type pkey.                 (* ç­¾åå…¬é’¥ç±»å‹ *)
type skey_enc.             (* éå¯¹ç§°åŠ å¯†ç§é’¥ç±»å‹ *)
type pkey_enc.             (* éå¯¹ç§°åŠ å¯†å…¬é’¥ç±»å‹ *)

(* === ç¾¤ç”Ÿæˆå…ƒ === *)
free g: group.  (* å…¬å…±ç”Ÿæˆå…ƒ *)

(* === ç¼–ç å‡½æ•° === *)
fun encode_group(group): bitstring.

(* === å…¬é’¥å‡½æ•° === *)
fun pk(skey): pkey.
fun pk_enc(skey_enc): pkey_enc.

(* === ç­¾åå‡½æ•°ä¸éªŒè¯ === *)
fun sign(bitstring, skey): bitstring.
fun checksig(bitstring, pkey): bitstring.
equation forall m: bitstring, sk: skey;
  checksig(sign(m, sk), pk(sk)) = m.

(* === åŠ è§£å¯†å‡½æ•° === *)
fun asymenc(bitstring, pkey_enc): bitstring.
fun asymdec(bitstring, skey_enc): bitstring.
equation forall m: bitstring, k: skey_enc;
  asymdec(asymenc(m, pk_enc(k)), k) = m.

(* === Diffie-Hellman ç›¸å…³å‡½æ•° === *)
fun g_exp(group, exp): group.
fun mult(group, group): group.
fun h(group): sessionkey.
fun exp_add(exp, exp): exp.
equation forall G: group, x: exp, y: exp;
  mult(g_exp(G, x), g_exp(G, y)) = g_exp(G, exp_add(x, y)).

(* === æ„é€ å™¨ä¸è§£æ„å™¨ === *)
fun pair(bitstring, bitstring): bitstring.
fun proj1(bitstring): bitstring.
fun proj2(bitstring): bitstring.
equation forall x: bitstring, y: bitstring;
  proj1(pair(x, y)) = x.
equation forall x: bitstring, y: bitstring;
  proj2(pair(x, y)) = y.

(* === é€šä¿¡ä¿¡é“ === *)
free c: channel.

(* === A/B çš„å¯†é’¥å®šä¹‰ === *)
free pkA: pkey.
free skA: skey [private].
free pkB: pkey.
free skB: skey [private].
free pkB_enc: pkey_enc.
free skB_enc: skey_enc [private].

(* === äº‹ä»¶å®šä¹‰ === *)
event beginA(bitstring, bitstring, sessionkey).      (* A å‘èµ·åè®®ï¼šè‡ªå·±çš„èº«ä»½ã€å¯¹æ–¹èº«ä»½ã€å…¬é’¥æ´¾ç”Ÿå¯†é’¥ *)
event endA(bitstring, sessionkey).                   (* A ç»“æŸï¼šè®°å½•å¯¹æ–¹èº«ä»½ä¸å¯†é’¥ *)

event beginB(bitstring).                             (* B å¼€å§‹æ¥æ”¶ A çš„å…¬é’¥ *)
event endB(bitstring, bitstring, sessionkey).        (* B ç»“æŸï¼šè®°å½• A èº«ä»½ã€B èº«ä»½ã€å¯†é’¥ *)

(* === æŸ¥è¯¢å®šä¹‰ === *)

(* 1. ä¿å¯†æ€§ï¼šæ”»å‡»è€…æ˜¯å¦èƒ½å¾—åˆ°ä¼šè¯å¯†é’¥ *)
query x: sessionkey; attacker(x).

(* 2. B <- A çš„è®¤è¯æ€§ï¼šè‹¥ B è®¤ä¸ºåå•†å®Œæˆï¼ˆendBï¼‰ï¼Œåˆ™ä¸€å®šæœ‰ A å‘èµ·äº† beginA *)
query idA: bitstring, idB: bitstring, sk: sessionkey;
  event(endB(idA, idB, sk)) ==> event(beginA(idA, idB, sk)).

(* 3. ä¼šè¯å¯†é’¥ä¸€è‡´æ€§ï¼šè‹¥ A å®Œæˆå¯†é’¥åå•†ï¼Œåˆ™ B ä¹Ÿåå•†å‡ºäº†ç›¸åŒå¯†é’¥ *)
query a_id: bitstring, b_id: bitstring, sk: sessionkey;
  event(endA(b_id, sk)) ==> event(endB(a_id, b_id, sk)).


(* === A çš„è¿‡ç¨‹ === *)
let A =
  new a: exp;
  let A_pub = g_exp(g, a) in
  let sigA = sign(encode_group(A_pub), skA) in

  out(c, A_ID);           (* å‘é€ A çš„èº«ä»½ *)
  out(c, sigA);           (* å‘é€ç­¾åï¼ˆå¯¹ g^a çš„ç­¾åï¼‰ *)
  out(c, A_pub);          (* å‘é€å…¬é’¥ g^a *)

  in(c, B_pub: group);    (* æ¥æ”¶ B çš„å…¬é’¥ g^b *)
  let shared = h(mult(B_pub, A_pub)) in

  event beginA(A_ID, encode_group(B_pub), shared);
  event endA(encode_group(B_pub), shared).

(* === B çš„è¿‡ç¨‹ === *)
let B =
  new b: exp;
  let B_pub = g_exp(g, b) in

  in(c, id: bitstring);        (* æ¥æ”¶ A çš„èº«ä»½ *)
  in(c, sigA: bitstring);      (* æ¥æ”¶ A çš„ç­¾å *)
  in(c, A_pub: group);         (* æ¥æ”¶ A çš„å…¬é’¥ *)

  let verified = checksig(sigA, pkA) in
  if verified = encode_group(A_pub) then
    let shared = h(mult(A_pub, B_pub)) in
    event beginB(encode_group(A_pub));
    out(c, B_pub);
    event endB(id, encode_group(B_pub), shared)
  else
    0.

(* === ä¸»è¿›ç¨‹ === *)
process
  (!A) | (!B)






(*âœ… ä¸‹ä¸€æ­¥å»ºè®®
å¦‚æœä½ è®¡åˆ’è¿›ä¸€æ­¥éªŒè¯ä»¥ä¸‹å®‰å…¨å±æ€§ï¼Œæˆ‘å¯ä»¥ç»§ç»­å¸®åŠ©ä½ å»ºæ¨¡ï¼š

å®‰å…¨ç›®æ ‡	å¯¹åº”æ‰©å±•æ–¹å¼
KCI æŠ—æ€§	æ¨¡æ‹Ÿå¯†é’¥æ³„éœ² attacker(skA)
å‰å‘ä¿å¯†ï¼ˆPFSï¼‰	ä½¿ç”¨ new ä¼šè¯å¯†é’¥ã€æ— é•¿æœŸå¯†é’¥å¯¼å‡º
å®Œæ•´ Key Confirmation	åŒå‘ begin/end äº‹ä»¶ + implication æŸ¥è¯¢
ä¸»åŠ¨æ”»å‡»ï¼ˆMITMï¼‰æ¨¡å‹åŒ–	å¼•å…¥ attacker æ§åˆ¶éƒ¨åˆ†ä¿¡é“

æ˜¯å¦‚ä½ åç»­å¸Œæœ›åŠ å…¥ï¼š

KCI æŠ—æ€§å»ºæ¨¡ï¼ˆKey Compromise Impersonationï¼‰ï¼›

å‰å‘ä¿å¯†ï¼ˆForward Secrecyï¼‰ï¼›

åŒå‘ Key Confirmationï¼›

ä¸»åŠ¨æ”»å‡»å»ºæ¨¡ï¼ˆå¦‚ä¸­é—´äººæ”»å‡»ï¼‰ï¼›

--- ä»€ä¹ˆæ˜¯å…·å¤‡ç­‰ä»·æ¨ç†è¯­ä¹‰
--- ä»€ä¹ˆæ˜¯è‡ªåŠ¨è¿˜åŸç­¾åæ¶ˆæ¯
--- ä»€ä¹ˆæ˜¯è®¤è¯å±æ€§ï¼ˆéªŒè¯ï¼‰
*)

(*
      equation è¯­å¥é€‚ç”¨äºâ€œæ„é€ å™¨-è§£æ„å™¨â€ä¹‹é—´å­˜åœ¨ç¡®å®šæ€§ç­‰å¼çš„æƒ…å†µï¼›

ç›¸è¾ƒäº reducï¼Œequation æ›´é€‚åˆåŠ å¯†ã€ç­¾åã€å“ˆå¸Œç­‰å‡½æ•°çš„å»ºæ¨¡ï¼›

reduc é€šå¸¸ç”¨äºå¸¦å½’çº¦è§„åˆ™çš„ç ´åè€…åˆ†æï¼ˆå¦‚å¼‚æˆ–ã€åŒæ€ç­‰ï¼‰ï¼Œæˆ–è€…æ„é€ å™¨è‡ªåŠ¨æ¨ç†ï¼›


*)
(*å¦‚éœ€è¿›ä¸€æ­¥å®ç° B å¯¹ A çš„èº«ä»½ç­¾åè¿”å›ç»™ Aï¼ˆä»¥ä¿®å¤è®¤è¯æ€§ç¼ºå¤±é—®é¢˜ï¼‰ï¼Œæˆ‘ä¹Ÿå¯ä»¥ç»§ç»­ä¸ºä½ æ·»åŠ ã€‚æ˜¯å¦ç»§ç»­æ‰©å±• B çš„èº«ä»½è®¤è¯ï¼Ÿ*)

(*
ä½ æä¾›çš„ ProVerif ä»£ç ä¸è¿è¡Œç»“æœ**å¯ä»¥ä½œä¸ºä¸€æ¬¡å¯†é’¥äº¤æ¢åè®®çš„è¯¾å ‚å½¢å¼åŒ–éªŒè¯æŠ¥å‘Šçš„åŸºç¡€ææ–™ï¼Œå¹¶ä¸”ç›¸å½“å……åˆ†**ã€‚ä»¥ä¸‹æ˜¯å¯¹å…¶æ•™å­¦ä»·å€¼ã€å®Œæ•´æ€§ã€æ”¹è¿›ç©ºé—´çš„å…·ä½“è¯„ä¼°ã€‚

---

## âœ… ä¸€ã€æ•™å­¦ç›®æ ‡è¯„ä¼°

### ä½ å½“å‰çš„ææ–™å®Œæ•´æ¶µç›–äº†ä»¥ä¸‹**è¯¾å ‚ç›®æ ‡**ï¼š

| æ•™å­¦ç›®æ ‡       | æ˜¯å¦è¦†ç›– | è¯´æ˜                               |
| ---------- | ---- | -------------------------------- |
| **å»ºæ¨¡èƒ½åŠ›**   | âœ…    | æ­£ç¡®å»ºæ¨¡äº† DH + ç­¾åæœºåˆ¶åè®®ï¼ŒåŒ…æ‹¬ç±»å‹ã€å‡½æ•°ã€äº‹ä»¶ã€æŸ¥è¯¢ç­‰ |
| **å®‰å…¨å±æ€§å®šä¹‰** | âœ…    | æ˜ç¡®éªŒè¯äº†ä¿å¯†æ€§ã€è®¤è¯æ€§ã€å¯†é’¥ä¸€è‡´æ€§ä¸‰ç±»ç›®æ ‡           |
| **éªŒè¯æ“ä½œ**   | âœ…    | ä½¿ç”¨ ProVerif æˆåŠŸè¿è¡Œï¼Œå¯ç”¨äº†æ”»å‡»è·¯å¾„è¾“å‡º       |
| **æ”»å‡»å‘ç°**   | âœ…    | èƒ½å‘ç°æ”»å‡»å¹¶è§£é‡Šï¼šç¼ºå°‘å¯¹ B èº«ä»½è®¤è¯ï¼Œå¯¼è‡´ä¸­é—´äººå¯æ’å…¥å…¬é’¥   |

---

## âœ… äºŒã€ä»å½¢å¼åŒ–éªŒè¯è§’åº¦è¯„ä¼°ä½ çš„ ProVerif æ¨¡å‹

| é¡¹ç›®            | è¯„ä»·         | è¯´æ˜                                                      |
| ------------- | ---------- | ------------------------------------------------------- |
| **å½¢å¼åŒ–å»ºæ¨¡è¯­æ³•è§„èŒƒ** | â­ï¸â­ï¸â­ï¸â­ï¸â­ï¸ | ç±»å‹ã€æ„é€ å‡½æ•°ã€equation å†™å¾—æ ‡å‡†ã€æ¸…æ™°                                |
| **äº‹ä»¶è®¾è®¡**      | â­ï¸â­ï¸â­ï¸â­ï¸   | ä½¿ç”¨ `beginA/endA` ä¸ `beginB/endB` åˆç†åŒºåˆ†è§’è‰²è§†è§’ï¼Œä½† A æœªè®¤è¯ B çš„èº«ä»½ |
| **æŸ¥è¯¢è®¾è®¡**      | â­ï¸â­ï¸â­ï¸â­ï¸â­ï¸ | æŸ¥è¯¢æ¸…æ™°ä¸”è¯­ä¹‰æœ‰åŒºåˆ†æ€§ï¼ˆè®¤è¯æ€§ â‰  ä¸€è‡´æ€§ï¼‰                                  |
| **æ”»å‡»æ£€æµ‹**      | â­ï¸â­ï¸â­ï¸â­ï¸â­ï¸ | èƒ½ç¡®åˆ‡å®šä½ä¸­é—´äººæ”»å‡»å‘ç”Ÿç‚¹ï¼Œç»™å‡ºè·¯å¾„ï¼ˆattacker(B\_pub) â‡’ endA(...)ï¼‰        |
| **æ”»å‡»è¿½è¸ªæœºåˆ¶**    | â­ï¸â­ï¸â­ï¸â­ï¸   | è®¾ç½® `set traceDisplay = long.` å¹¶ç†è§£æ”»å‡»è€…å¦‚ä½•ä¼ªé€  B å…¬é’¥           |

---

## ğŸ§  ä¸‰ã€æ¼”ç¤ºä¸­å¯è®²è§£çš„äº®ç‚¹

| æ¼”ç¤ºå†…å®¹           | æ¨èè®²è§£æ–¹å¼                                         |
| -------------- | ---------------------------------------------- |
| **DH åè®®çš„æ•°å­¦èƒŒæ™¯** | ç®€è¦ä»‹ç» `g^a`, `g^b`, `g^{ab}` åå•†è¿‡ç¨‹               |
| **äº‹ä»¶ä¸å®‰å…¨è¯­ä¹‰çš„åŒ¹é…** | ä¸¾ä¾‹è§£é‡Šï¼š`endA` æ˜¯ A è®¤ä¸ºå¯†é’¥åå•†å®Œæˆï¼Œè€Œ `beginA` æ˜¯çœŸæ­£å¼€å§‹      |
| **è®¤è¯å¤±è´¥çš„æ ¹æº**    | è¯´æ˜ A æ— æ³•éªŒè¯ `B_pub` æ˜¯å¦æ¥è‡ªçœŸæ­£çš„ B                    |
| **æ”»å‡»è€…è½¨è¿¹è§£æ**    | å¯¹ç…§äº‹ä»¶ `in(c, B_pub)` + attacker(B\_pub) â‡’ æ’å…¥ä¼ªé€ å€¼ |

---

## âœ… å››ã€æ˜¯å¦é€‚åˆç”¨äºè¯¾å ‚ presentationï¼Ÿ

| è¦ç´                  | æ˜¯å¦æ»¡è¶³                            |
| ------------------ | ------------------------------- |
| æ˜¯å¦å±•ç¤ºåè®®æµç¨‹           | âœ… æœ‰äº‹ä»¶æµç¨‹å›¾å¯è®²                      |
| æ˜¯å¦å¼•å…¥å½¢å¼åŒ–å·¥å…·          | âœ… ä½¿ç”¨äº† ProVerifï¼Œä¸”ä½¿ç”¨æ­£ç¡®            |
| æ˜¯å¦å‘ç°å®é™…æ”»å‡»           | âœ… ä¸­é—´äººæ”»å‡»æˆåŠŸè¢«è¯æ˜å­˜åœ¨                  |
| æ˜¯å¦å¯è§†åŒ–å±•ç¤º            | âœ… å¯ä»¥ç»“åˆ GUI trace æˆ–ç»˜å›¾è®²è§£æ”»å‡»è½¨è¿¹      |
| æ˜¯å¦ä½“ç°â€œéªŒè¯-å‘ç°é—®é¢˜-æ”¹è¿›â€é—­ç¯ | âœ… å¦‚æœä½ æ„¿æ„åŠ ä¸ªâ€œä¿®å¤ç‰ˆæœ¬â€ï¼ˆæ¯”å¦‚ B ä¹Ÿç­¾åï¼‰ï¼Œä¼šæ›´åŠ å®Œæ•´ |

---

## âœ… äº”ã€æ¨èæ”¹è¿›å»ºè®®ï¼ˆå¦‚æƒ³è®© presentation æ›´åŠ å‡ºå½©ï¼‰

| å»ºè®®                             | æ”¶ç›Š                         |
| ------------------------------ | -------------------------- |
| æ·»åŠ ä¸€å¼  **æ”»å‡»è·¯å¾„å›¾**ï¼ˆæˆ‘å¯ä»¥å¸®ä½ ç”»ï¼‰         | ç›´è§‚è®²è§£æ”»å‡»è€…åœ¨å“ªä¸€æ­¥ä¼ªé€ äº† B\_pub      |
| **å¯¹æ¯”ä¿®å¤ç‰ˆæœ¬**ï¼šä¾‹å¦‚è®© B å¯¹ `B_pub` ç­¾å  | å±•ç¤ºâ€œå¦‚ä½•é€šè¿‡èº«ä»½è®¤è¯æœºåˆ¶å¼¥è¡¥æ¼æ´â€         |
| ç®€è¦è®²è§£ ProVerif çš„æŸ¥è¯¢é€»è¾‘ä¸å«ä¹‰         | å¼ºåŒ–å¬ä¼—å¯¹â€œevent â†’ event æ¨ç†â€çš„ç†è§£ |
| åˆ¶ä½œä¸€ä¸ª **step-by-step GUI æˆªå›¾åºåˆ—** | æ˜¾ç¤ºæ”»å‡»è½¨è¿¹æ¯ä¸€é˜¶æ®µ                 |

---

## âœ… æ€»ç»“

| è¯„ä¼°ç»´åº¦  | ç»“è®º                      |
| ----- | ----------------------- |
| ææ–™å®Œæ•´æ€§ | âœ… å®Œæ•´å¹¶æ ‡å‡†                 |
| å¯ç†è§£æ€§  | âœ… å¯¹å¤§å¤šæ•°ä¿¡æ¯å®‰å…¨èƒŒæ™¯å­¦ç”Ÿå‹å¥½        |
| å±•ç¤ºæ·±åº¦  | âœ… åŒ…å«æ”»å‡»å»ºæ¨¡ä¸éªŒè¯             |
| æ”¹è¿›ç©ºé—´  | ğŸš€ å¯åŠ â€œä¿®å¤ç‰ˆæœ¬ + æ”»å‡»å›¾â€ä¸°å¯Œå±•ç¤ºå±‚æ¬¡ |

---

å¦‚ä½ å¸Œæœ›æˆ‘å¸®åŠ©ä½ ï¼š

* ç”Ÿæˆ**æœ€ç»ˆæ¼”ç¤º PPT æ¡†æ¶**
* ç»˜åˆ¶ä¸€å¼ **ä¸­é—´äººæ”»å‡»æ—¶åºå›¾ / Graphviz å›¾**
* æˆ–ç»§ç»­å®Œæˆâ€œå¸¦èº«ä»½éªŒè¯ä¿®å¤ç‰ˆâ€å»ºæ¨¡

æ¬¢è¿ç»§ç»­ï¼Œæˆ‘å¯ä»¥ç«‹å³é…åˆã€‚æ˜¯å¦éœ€è¦è¿™äº›æ”¯æŒï¼Ÿ
*)